<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVA Tool - Hybrid Edition</title>
    <script src="https://js.hcaptcha.com/1/api.js?render=explicit" async defer></script>
    <style>
        :root {
            --bg-color: #0d0d15;
            --card-bg: #1a1a2e;
            --text-color: #f0f0f5;
            --primary: #00d4ff;
            --secondary: #7000ff;
            --danger: #ff0055;
            --success: #00ffa3;
            --border: #2e2e4a;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }

        .container {
            width: 100%;
            max-width: 700px;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 0 40px rgba(0, 212, 255, 0.2);
            border: 1px solid var(--border);
        }

        header { text-align: center; margin-bottom: 25px; }
        .brand-title { 
            margin: 0; font-size: 32px; font-weight: 900; letter-spacing: 6px; 
            color: var(--primary); text-shadow: 0 0 20px rgba(0, 212, 255, 0.6);
            text-transform: uppercase;
        }

        .section { margin-bottom: 15px; }
        label { display: block; font-size: 11px; margin-bottom: 5px; color: var(--primary); font-weight: bold; text-transform: uppercase; }

        textarea, input[type="text"] {
            width: 100%; padding: 12px; background: #050510; border: 1px solid var(--border);
            border-radius: 8px; color: white; box-sizing: border-box; outline: none;
            font-family: 'Consolas', monospace; font-size: 13px;
        }

        textarea { height: 100px; }

        /* Captcha Area */
        #captcha-container {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: none; /* Captchaが必要な時だけ表示 */
            text-align: center;
        }

        .btn { 
            width: 100%; padding: 18px; border: none; border-radius: 8px; 
            font-weight: 900; cursor: pointer; text-transform: uppercase; transition: 0.2s; 
            background: linear-gradient(90deg, var(--primary), var(--secondary)); color: #000;
        }
        .btn:hover { filter: brightness(1.2); }

        .status-log {
            margin-top: 20px; background: #050510; border: 1px solid var(--border);
            border-radius: 8px; height: 200px; overflow-y: auto; padding: 12px;
            font-size: 11px; font-family: 'Consolas', monospace; color: #aaa;
        }
        .log-entry { margin-bottom: 4px; }
        .log-success { color: var(--success); }
        .log-error { color: var(--danger); }
        .log-info { color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 class="brand-title">NOVA TOOL</h1>
        <p style="font-size: 10px; opacity: 0.6; text-align: center;">JOINER + BYPASS HYBRID</p>
    </header>

    <div class="section">
        <label>User Tokens (1行に1つ)</label>
        <textarea id="tokens" placeholder="Tokens here..."></textarea>
    </div>

    <div class="section">
        <label>Invite Link / Code</label>
        <input type="text" id="inviteInput" placeholder="https://discord.gg/xxxxxx">
    </div>

    <div class="section">
        <label>Target Message URL (リアクション/ボタン実行用)</label>
        <input type="text" id="msgUrl" placeholder="https://discord.com/channels/GUILD/CHANNEL/MSG">
    </div>

    <div id="captcha-container">
        <p id="captcha-status" style="font-size: 12px; color: var(--primary); margin-bottom: 10px;">CAPTCHA REQUIRED</p>
        <div id="captcha-box"></div>
    </div>

    <button id="startBtn" class="btn">Execute Full Sequence</button>

    <div class="status-log" id="logArea">
        <div class="log-entry">[SYSTEM] NOVA online. Standby.</div>
    </div>
</div>

<script>
    let captchaQueue = [];
    let isProcessingCaptcha = false;

    const logArea = document.getElementById('logArea');
    function addLog(text, type = '') {
        const div = document.createElement('div');
        div.className = `log-entry ${type ? 'log-' + type : ''}`;
        div.innerText = `[${new Date().toLocaleTimeString()}] ${text}`;
        logArea.prepend(div);
    }

    // --- Core Logic ---
    document.getElementById('startBtn').addEventListener('click', async () => {
        const tokens = document.getElementById('tokens').value.split('\n').filter(t => t.trim());
        const invite = document.getElementById('inviteInput').value.trim().split('/').pop();
        
        if (!tokens.length || !invite) return alert("トークンと招待コードを入力してください");

        addLog("シーケンス開始...", "info");

        for (const token of tokens) {
            await attemptJoin(token.trim(), invite);
        }
    });

    async function attemptJoin(token, inviteCode) {
        try {
            // 注意: ブラウザから直接叩くとCORS制限がかかるため、本来はproxyを介します
            const res = await fetch(`https://discord-api.soyaaaaana.com/invite/${inviteCode}`, {
                method: "POST",
                headers: { "Authorization": token, "Content-Type": "application/json" },
                body: JSON.stringify({ session_id: Math.random().toString(36).substring(2) })
            });

            const data = await res.json();

            if (res.status === 400 && data.captcha_sitekey) {
                addLog(`Captcha検知: ${token.substring(0,10)}...`, "info");
                captchaQueue.push({ token, inviteCode, ...data });
                if (!isProcessingCaptcha) processNextCaptcha();
            } else if (res.ok) {
                addLog(`参加成功: ${token.substring(0,10)}...`, "success");
                await executeBypass(token);
            } else {
                addLog(`エラー: ${res.status}`, "error");
            }
        } catch (e) {
            addLog("通信エラー", "error");
        }
    }

    // --- Captcha Handling ---
    function processNextCaptcha() {
        if (captchaQueue.length === 0) {
            isProcessingCaptcha = false;
            document.getElementById('captcha-container').style.display = 'none';
            addLog("すべてのCaptcha処理が終了しました", "success");
            return;
        }

        isProcessingCaptcha = true;
        const current = captchaQueue[0];
        document.getElementById('captcha-container').style.display = 'block';
        
        hcaptcha.render("captcha-box", {
            sitekey: current.captcha_sitekey,
            callback: async (token) => {
                await submitCaptcha(token);
                hcaptcha.reset();
                processNextCaptcha();
            }
        });
    }

    async function submitCaptcha(captchaKey) {
        const current = captchaQueue.shift();
        const res = await fetch(`https://discord-api.soyaaaaana.com/invite/${current.inviteCode}`, {
            method: "POST",
            headers: {
                "Authorization": current.token,
                "x-captcha-key": captchaKey,
                "x-captcha-rqtoken": current.captcha_rqtoken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ session_id: Math.random().toString(36).substring(2) })
        });

        if (res.ok) {
            addLog(`Captcha突破・参加成功`, "success");
            await executeBypass(current.token);
        } else {
            addLog(`Captcha後エラー: ${res.status}`, "error");
        }
    }

    // --- Bypass Actions (Reaction & Buttons) ---
    async function executeBypass(token) {
        const msgUrl = document.getElementById('msgUrl').value.trim();
        if (!msgUrl) return;

        const parts = msgUrl.split('/');
        const gId = parts[parts.length - 3], cId = parts[parts.length - 2], mId = parts[parts.length - 1];

        try {
            // メッセージ取得
            const res = await fetch(`https://discord.com/api/v9/channels/${cId}/messages/${mId}`, {
                headers: { "Authorization": token }
            });
            const data = await res.json();

            // リアクション
            if (data.reactions) {
                for (const r of data.reactions) {
                    const emoji = r.emoji.id ? `${r.emoji.name}:${r.emoji.id}` : encodeURIComponent(r.emoji.name);
                    await fetch(`https://discord.com/api/v9/channels/${cId}/messages/${mId}/reactions/${emoji}/@me`, {
                        method: 'PUT', headers: { "Authorization": token }
                    });
                }
                addLog(`リアクション完了`, "success");
            }

            // ボタン
            const buttons = [];
            (data.components || []).forEach(row => row.components.forEach(c => { if(c.type === 2) buttons.push(c); }));
            for (const btn of buttons) {
                await fetch(`https://discord.com/api/v9/interactions`, {
                    method: 'POST',
                    headers: { "Authorization": token, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        type: 3, guild_id: gId, channel_id: cId, message_id: mId,
                        application_id: data.author.id, data: { component_type: 2, custom_id: btn.custom_id }
                    })
                });
            }
            if (buttons.length) addLog(`ボタン実行完了`, "success");

        } catch (e) {
            addLog("バイパス処理失敗", "error");
        }
    }
</script>

</body>
</html>
