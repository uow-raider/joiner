<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>NOVA Tool - Captcha Fix</title>
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    <style>
        :root { --bg: #0d0d15; --card: #1a1a2e; --primary: #00d4ff; --text: #f0f0f5; --border: #2e2e4a; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; display: flex; justify-content: center; padding: 20px; }
        .container { width: 100%; max-width: 600px; background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid var(--border); }
        .log-area { margin-top: 15px; height: 150px; background: #000; border: 1px solid var(--border); padding: 10px; overflow-y: auto; font-size: 11px; color: #00ffa3; }
        #captcha-box { margin-top: 20px; min-height: 300px; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.2); border-radius: 8px; }
        .input-group { margin-bottom: 10px; }
        input, textarea { width: 100%; padding: 10px; background: #050510; border: 1px solid var(--border); color: #fff; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; background: var(--primary); color: #000; border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h2>NOVA Tool - Captcha Repair</h2>
    <div class="input-group"><textarea id="tokens" placeholder="Tokens (1 per line)"></textarea></div>
    <div class="input-group"><input type="text" id="invite" placeholder="Invite Code (e.g. xxxxx)"></div>
    <button id="start" class="btn">START</button>
    <div id="captcha-box"></div>
    <div id="log" class="log-area"></div>
</div>

<script>
let queue = [];
let processing = false;

function log(msg) {
    const l = document.getElementById("log");
    l.innerText += `\n[${new Date().toLocaleTimeString()}] ${msg}`;
    l.scrollTop = l.scrollHeight;
}

// ブラウザの情報を偽装
function getProps() {
    return btoa(JSON.stringify({"os":"Windows","browser":"Chrome","device":"","system_locale":"ja-JP","client_build_number":255100}));
}

document.getElementById("start").addEventListener("click", async () => {
    const tokens = document.getElementById("tokens").value.split("\n").filter(t => t.trim());
    const invite = document.getElementById("invite").value.trim().split("/").pop();
    
    for (const token of tokens) {
        await join(token.trim(), invite);
    }
});

async function join(token, invite, capKey = null, capData = null) {
    const headers = {
        "authorization": token,
        "content-type": "application/json",
        "x-super-properties": getProps()
    };
    if (capKey) {
        headers["x-captcha-key"] = capKey;
        headers["x-captcha-rqtoken"] = capData.rqtoken;
    }

    try {
        const res = await fetch(`https://discord-api.soyaaaaana.com/invite/${invite}`, {
            method: "POST",
            headers: headers,
            body: JSON.stringify({ session_id: Math.random().toString(36).substring(2) })
        });

        const data = await res.json();
        if (res.status === 400 && data.captcha_sitekey) {
            log("Captchaが必要なトークンを検知...");
            queue.push({ token, invite, ...data });
            if (!processing) next();
        } else if (res.ok) {
            log("参加成功！");
        } else {
            log(`エラー: ${res.status}`);
        }
    } catch (e) { log("エラーが発生しました"); }
}

function next() {
    if (queue.length === 0) {
        processing = false;
        log("全ての処理が完了しました");
        return;
    }
    processing = true;
    const current = queue[0];
    const box = document.getElementById("captcha-box");
    
    // 重要：既存のウィジェットを完全に削除
    box.innerHTML = '<div id="hcaptcha-target"></div>';

    // hCaptchaを明示的にレンダリング
    const widgetId = hcaptcha.render("hcaptcha-target", {
        sitekey: current.captcha_sitekey,
        callback: async (key) => {
            log("Captcha解決を送信中...");
            const task = queue.shift();
            // 解決後に再試行
            await join(task.token, task.invite, key, { rqtoken: task.captcha_rqtoken });
            next(); // 次のCaptchaへ
        }
    });

    // rqdataを即座に適用（これが400エラーを防ぐ）
    if (current.captcha_rqdata) {
        hcaptcha.setData(widgetId, { rqdata: current.captcha_rqdata });
    }
}
</script>
</body>
</html>
